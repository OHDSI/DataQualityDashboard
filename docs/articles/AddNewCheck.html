<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Add a New Data Quality Check • DataQualityDashboard</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/cosmo/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Add a New Data Quality Check">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">


    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">DataQualityDashboard</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">2.8.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home fa-lg"></span>

  </a>
</li>
<li>
  <a href="../articles/DataQualityDashboard.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles

    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/Thresholds.html">DQ Check Failure Thresholds</a>
    </li>
    <li>
      <a href="../articles/CheckStatusDefinitions.html">DQ Check Statuses</a>
    </li>
    <li>
      <a href="../articles/AddNewCheck.html">Adding a New Data Quality Check</a>
    </li>
    <li>
      <a href="../articles/DqdForCohorts.html">DQD for Cohorts</a>
    </li>
    <li>
      <a href="../articles/SqlOnly.html">SQL-only Mode</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Data Quality Check Types

    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/checkIndex.html">Index</a>
    </li>
    <li>
      <a href="../articles/checks/cdmTable.html">cdmTable</a>
    </li>
    <li>
      <a href="../articles/checks/cdmField.html">cdmField</a>
    </li>
    <li>
      <a href="../articles/checks/cdmDatatype.html">cdmDatatype</a>
    </li>
    <li>
      <a href="../articles/checks/isPrimaryKey.html">isPrimaryKey</a>
    </li>
    <li>
      <a href="../articles/checks/isForeignKey.html">isForeignKey</a>
    </li>
    <li>
      <a href="../articles/checks/isRequired.html">isRequired</a>
    </li>
    <li>
      <a href="../articles/checks/fkDomain.html">fkDomain</a>
    </li>
    <li>
      <a href="../articles/checks/fkClass.html">fkClass</a>
    </li>
    <li>
      <a href="../articles/checks/measurePersonCompleteness.html">measurePersonCompleteness</a>
    </li>
    <li>
      <a href="../articles/checks/measureValueCompleteness.html">measureValueCompleteness</a>
    </li>
    <li>
      <a href="../articles/checks/isStandardValidConcept.html">isStandardValidConcept</a>
    </li>
    <li>
      <a href="../articles/checks/standardConceptRecordCompleteness.html">standardConceptRecordCompleteness</a>
    </li>
    <li>
      <a href="../articles/checks/sourceConceptRecordCompleteness.html">sourceConceptRecordCompleteness</a>
    </li>
    <li>
      <a href="../articles/checks/sourceValueCompleteness.html">sourceValueCompleteness</a>
    </li>
    <li>
      <a href="../articles/checks/plausibleAfterBirth.html">plausibleAfterBirth</a>
    </li>
    <li>
      <a href="../articles/checks/plausibleBeforeDeath.html">plausibleBeforeDeath</a>
    </li>
    <li>
      <a href="../articles/checks/plausibleStartBeforeEnd.html">plausibleStartBeforeEnd</a>
    </li>
    <li>
      <a href="../articles/checks/plausibleValueHigh.html">plausibleValueHigh</a>
    </li>
    <li>
      <a href="../articles/checks/plausibleValueLow.html">plausibleValueLow</a>
    </li>
    <li>
      <a href="../articles/checks/withinVisitDates.html">withinVisitDates</a>
    </li>
    <li>
      <a href="../articles/checks/measureConditionEraCompleteness.html">measureConditionEraCompleteness</a>
    </li>
    <li>
      <a href="../articles/checks/measureObservationPeriodOverlap.html">measureObservationPeriodOverlap</a>
    </li>
    <li>
      <a href="../articles/checks/plausibleUnitConceptIds.html">plausibleUnitConceptIds</a>
    </li>
    <li>
      <a href="../articles/checks/plausibleGenderUseDescendants.html">plausibleGenderUseDescendants</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://ohdsi.github.io/Hades" class="external-link"><img src='https://ohdsi.github.io/Hades/images/hadesMini.png' width=80 height=17 style='vertical-align: top;'></a>
</li>
<li>
  <a href="https://github.com/OHDSI/DataQualityDashboard/" class="external-link">
    <span class="fab fa-github fa-lg"></span>

  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->



      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Add a New Data Quality Check</h1>
                        <h4 data-toc-skip class="author">Don Torok</h4>
            
            <h4 data-toc-skip class="date">2025-09-23</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/OHDSI/DataQualityDashboard/blob/HEAD/vignettes/AddNewCheck.rmd" class="external-link"><code>vignettes/AddNewCheck.rmd</code></a></small>
      <div class="hidden name"><code>AddNewCheck.rmd</code></div>

    </div>

    
    
<div class="section level2">
<h2 id="add-a-new-check-to-data-quality-dashboard">Add a New Check to Data Quality Dashboard<a class="anchor" aria-label="anchor" href="#add-a-new-check-to-data-quality-dashboard"></a>
</h2>
<div class="section level3">
<h3 id="steps">Steps<a class="anchor" aria-label="anchor" href="#steps"></a>
</h3>
<ol style="list-style-type: decimal">
<li>Write the SQL query for your check.</li>
<li>Format the Query for the Data Quality Dashboard</li>
<li>Add the Query to Check Descriptions File</li>
<li>Add Hooks to Field, Table or Concept Check CSV File</li>
</ol>
<p>The following will show, by example, how to add a check that
emergency visits in the CDM are less than or equal to two days. ## Write
the SQL Query for Your Check The query should return the number of rows
that fail the check, i.e. the duration of the ER visit is greater than
two days.</p>
<pre><code>    SELECT count(*)
    FROM visit_occurrence
    WHERE visit_concept_id = 9203 /* ER visit */
      AND dateDiff(days, visit_start_date, visit_end_date) &gt; 2;</code></pre>
</div>
<div class="section level3">
<h3 id="format-the-query-for-the-data-quality-dashboard">Format the Query for the Data Quality Dashboard<a class="anchor" aria-label="anchor" href="#format-the-query-for-the-data-quality-dashboard"></a>
</h3>
<p>In the DataQualityDashboard git directory
DataQualityDashboard/inst/sql/sql_server are the SQL files that
implement the various data quality checks. The files have the following
input parameters: <span class="citation">@cdmDatabaseSchema</span> <span class="citation">@vocabDatabaseSchema</span> <span class="citation">@cdmTableName</span> <span class="citation">@cdmFieldName</span></p>
<p>And the result of the query is expected to have the following fields:
num_violated_rows; pct_violated_rows; num_denominator_rows</p>
<p>Its best to find an existing query similar to the test you want to
implement and use that as a starting point for your test query.</p>
<pre><code>    SELECT num_violated_rows
        , CASE WHEN denominator.num_rows = 0 
               THEN 0 
               ELSE 1.0*dqd_check.num_violated_rows/denominator.num_rows 
         END  AS pct_violated_rows, 
      denominator.num_rows as num_denominator_rows
    FROM
    (
        &lt;Your query that returns num_violated_rows&gt;
         
    ) dqd_check
    CROSS JOIN
    ( 
        SELECT COUNT_BIG(*) AS num_rows
        FROM @cdmDatabaseSchema.@cdmTableName cdmTable
    ) denominator;</code></pre>
<p>The initial query should then be set up to use the input parameters.
This test is only valid for Visit Occurrence and the columns
visit_start_date, visit_end_date, and visit_concept_id are fixed. As a
result we only need to add the <span class="citation">@cdmDatabaseSchema</span> and <span class="citation">@cdmTableName</span> parameters and alias the count(*)
field to <strong>num_violated_rows</strong></p>
<pre><code>    SELECT count(*) AS num_violated_rows
    FROM @cdmDatabaseSchema.@cdmTableName
    WHERE visit_concept_id = 9203 /* ER visit */
     AND dateDiff(days, visit_start_date, visit_end_date) &gt; 2</code></pre>
<p>Paste the check for violating rows into the template from a similar
query and test the complete query on a OMOP CDM. A good way to confirm
that the input parameters are correct is to use launchSqlRenderDeveloper
from the SQLRender package. The package is included in the Data Quality
R project.</p>
<div class="float">
<img src="images/library_SQLRender.png" alt="Figure 1: launchSqlRenderDeveloper"><div class="figcaption">Figure 1: launchSqlRenderDeveloper</div>
</div>
<p>This will bring up a SqlRender window in your browser. Paste in your
complete DQ query. The program will see the input parameters and allow
you to define them. The rendered translation, dialect specific, is
output. You can run the “Rendered Translation” on your OMOP CDM.</p>
<div class="float">
<img src="images/SQLRenderDeveloper.png" alt="Figure 2: launchSqlRenderDeveloper"><div class="figcaption">Figure 2: launchSqlRenderDeveloper</div>
</div>
<p>SQL Server SQL is the lingua franca for Data Quality Dashboard
queries. SQLRender will modify the query to other SQL dialects. See <a href="https://cran.r-project.org/web/packages/SqlRender/index.html" class="external-link">SQLRender
on CRAN</a> for additional information. When satisfied with the results
of the query save the SQL in a file named ERVisitLength.sql in the
directory DataQualityDashboard/inst/sql/sql_server.</p>
</div>
<div class="section level3">
<h3 id="add-the-query-to-check-descriptions-file">Add the Query to Check Descriptions File<a class="anchor" aria-label="anchor" href="#add-the-query-to-check-descriptions-file"></a>
</h3>
<p>The Check Description file is found in the
DataQualityDashboard/inst/csv directory. There is a Check Description
for each CDM release. Within the Check Description file are the
following columns: - checkLevel – Possible values are TABLE, FIELD or
CONCEPT. This is the csv file that has the information telling the DQD
code on what tables and fields to run the check. For our example, check
of the length of an ER stay, this will be the csv file with field level
checks. - checkName – Name used in the DQD code to identify the check.
For this example use <strong>ERVisitLength</strong> - checkDescription –
Short user provided description of what the check does. This description
is displayed in the DQD results. - kahnContext – The following 3 columns
are a means of organizing quality checks. For additional information see
<a href="https://www.ncbi.nlm.nih.gov/pmc/articles/PMC5051581/" class="external-link">Harmonized
Data Quality Assessment Terminology and Framework</a>. For this example
use ‘Verification’ - kahnCategory – Use ‘Plausibility’ - kahnSubcategory
– Use ‘Temporal’ - sqlFile – The name of the SQL file we created above.
The name should include the values for checkLevel and checkName. For
example, field_ERVisitLength.sql - evaluationFilter – This is a column
name in the Field Check csv file and a conditional statement, that when
TRUE will result in the DQD code running the check. This will become
clearer after describing how to update the Field Checks csv file in the
next section. For this example use
<strong>ERVisitLength==‘Yes’</strong>. This means run our test when the
row value in the column headed ERVisitLength equals Yes.</p>
</div>
<div class="section level3">
<h3 id="add-hooks-to-fieldtableconcept-check-csv-file">Add Hooks to Field/Table/Concept Check CSV File<a class="anchor" aria-label="anchor" href="#add-hooks-to-fieldtableconcept-check-csv-file"></a>
</h3>
<p>The field level check file, OMOP_CDMv5.4_Field_Level.csv, is in the
same directory as the Check Descriptions file. The first two columns are
‘cdmTableName’ and ‘cdmFieldName’. There is a row for each table/column
in the OMOP CDM. After the first two columns are triplets of columns
with the naming scheme <strong>testName</strong>,
<strong>testNameThreshold</strong>, <strong>testNameNotes</strong>. We
need to add these columns for our ER visit length test. The testName is
the name used in defining the evaluationFilter column in the above step,
<strong>ERVisitLength</strong>. The other two column names are
ERVisitLengthThreshold and ERVisitLengthNotes. The evaluation filter we
added, ERVisitLengh==‘Yes’ means that for every table/column in this
file where the row value in the column ERVisitLength is ‘Yes’, run the
SQL in the file we created, ERVisitLength.sql, passing in the schema,
table and column names. (The schema name is defined when running the DQD
code.) For this example the only row with a Yes will be for the
visit_date_date in the visit_occurrence table.</p>
<p>The testNameThreshold column should have a value between 0 and 100
for all rows where there is a Yes in the testName column. Remember the
SQL in ERVisitLength.sql returns the pct_violated_rows. If
pct_violated_row is greater than the threshold the test is recorded as
failed. If our threshold is 0 then any ER visit with a length greater
than two days will return a pct_violated_row greater than zero and the
test will fail. If you want to allow for a few ‘bad’ visit lengths you
can set the threshold to a low number. Or if you want the test to be
run, but never flag an error, set the threshold to 100.</p>
<p>The testNameNotes column is usually left blank. The convention is
that this column will be used by the person running the tests to
document circumstances in the source data that might cause the test to
fail.</p>
<p>Add the above three columns to the end of the csv file. In the row
for Visit Occurrence/Visit start date put ‘Yes’ in the ERVisitLength
column and 0 in the ERVisitLengthThreshold column. Our test will be run
once whenever field level checks are run. If any ER visit length is
greater than two days the check will be marked as failed.</p>
<p>You can run just the ERVisitLength test by setting the input
parameter checkNames = c(“ERVisitLength”) in the R program
DataQualityDashboard::executeDqChecks.</p>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

      </div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Katy Sadowski, Clair Blacketer, Maxim Moinat, Ajit Londhe, Anthony Sena, Anthony Molinaro, Frank DeFalco, Pavel Grafkin.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.2.</p>
</div>

      </footer>
</div>






  </body>
</html>
